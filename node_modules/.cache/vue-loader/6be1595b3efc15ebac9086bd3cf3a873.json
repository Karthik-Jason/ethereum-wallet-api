{"remainingRequest":"/home/karthik/Desktop/myetherwallet/MyEtherWallet/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/karthik/Desktop/myetherwallet/MyEtherWallet/src/dapps/MakerDai/MakerDai.vue?vue&type=script&lang=js&","dependencies":[{"path":"/home/karthik/Desktop/myetherwallet/MyEtherWallet/src/dapps/MakerDai/MakerDai.vue","mtime":1573477611644},{"path":"/home/karthik/Desktop/myetherwallet/MyEtherWallet/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/karthik/Desktop/myetherwallet/MyEtherWallet/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/home/karthik/Desktop/myetherwallet/MyEtherWallet/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/home/karthik/Desktop/myetherwallet/MyEtherWallet/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { mapState } from 'vuex';\nimport BackButton from '@/layouts/InterfaceLayout/components/BackButton';\nimport InterfaceContainerTitle from '@/layouts/InterfaceLayout/components/InterfaceContainerTitle';\nimport InterfaceBottomText from '@/components/InterfaceBottomText';\nimport Blockie from '@/components/Blockie';\nimport CloseCdpModal from './components/CloseCdpModal';\nimport MoveCdpModal from './components/MoveCdpModal';\nimport GenerateModal from './components/GenerateModal';\nimport DepositModal from './components/DepositModal';\nimport WithdrawModal from './components/WithdrawModal';\nimport PaybackModal from './components/PaybackModal';\nimport BigNumber from 'bignumber.js';\nimport Maker from '@makerdao/dai';\nimport { Toast } from '@/helpers';\nimport MakerCDP from './MakerCDP';\nimport { toChecksumAddress } from '@/helpers/addressUtils';\n\nimport MewPlugin from 'mew-maker-plugin';\nconst { MKR, DAI } = Maker;\n\nconst toBigNumber = num => {\n  return new BigNumber(num);\n};\n\nconst bnOver = (one, two, three) => {\n  return toBigNumber(one)\n    .times(toBigNumber(two))\n    .div(toBigNumber(three));\n};\n\nexport default {\n  components: {\n    'interface-container-title': InterfaceContainerTitle,\n    'interface-bottom-text': InterfaceBottomText,\n    'generate-modal': GenerateModal,\n    'deposit-modal': DepositModal,\n    'withdraw-modal': WithdrawModal,\n    'payback-modal': PaybackModal,\n    blockie: Blockie,\n    'back-button': BackButton,\n    'close-cdp-modal': CloseCdpModal,\n    'move-cdp-modal': MoveCdpModal\n  },\n  props: {\n    tokensWithBalance: {\n      type: Array,\n      default: function() {\n        return [];\n      }\n    },\n    getBalance: {\n      type: Function,\n      default: function() {}\n    },\n    highestGas: {\n      type: String,\n      default: '0'\n    }\n  },\n  data() {\n    return {\n      destAddressProxy: '',\n      destAddressHasProxy: false,\n      afterUpdate: [],\n      allCdpIds: [],\n      activeCdp: {},\n      activeValues: {\n        maxPethDraw: toBigNumber(0),\n        maxEthDraw: toBigNumber(0),\n        maxUsdDraw: toBigNumber(0),\n        ethCollateral: toBigNumber(0),\n        pethCollateral: toBigNumber(0),\n        usdCollateral: toBigNumber(0),\n        debtValue: toBigNumber(0),\n        maxDai: toBigNumber(0),\n        collateralRatio: toBigNumber(0),\n        minEth: toBigNumber(0),\n        cdpId: '--'\n      },\n      availableCdps: {},\n      cdps: [],\n      cdpsWithoutProxy: [],\n      cdpService: {},\n      cdpDetailsLoaded: false,\n      currentProxy: null,\n      currentCdpId: '',\n      creatingCdp: false,\n      daiPrice: 0,\n      daiQty: 0,\n      ethPrice: toBigNumber(0),\n      ethQty: 0,\n      liquidationRatio: toBigNumber(0),\n      liquidationPenalty: toBigNumber(0),\n      makerActive: false,\n      makerCdp: {},\n      makerManager: {},\n      migrationInProgress: {},\n      openCloseModal: false,\n      openMoveModal: false,\n      proxyService: {},\n      proxyAddress: null,\n      pethPrice: toBigNumber(0),\n      pethMin: toBigNumber(0),\n      priceService: {},\n      priceFloor: 0,\n      stabilityFee: toBigNumber(0),\n      sysVars: {},\n      sysServices: {},\n      targetPrice: 0,\n      valuesUpdated: 0,\n      wethToPethRatio: toBigNumber(0)\n    };\n  },\n  computed: {\n    ...mapState(['account', 'gasPrice', 'web3', 'network', 'ens']),\n    maxDaiDraw() {\n      if (this.ethQty <= 0) return 0;\n      return bnOver(this.ethPrice, this.ethQty, this.liquidationRatio);\n    },\n    minEthDeposit() {\n      if (this.daiQty <= 0) return 0;\n      return bnOver(this.liquidationRatio, this.daiQty, this.ethPrice);\n    },\n    showMoveOrClose() {\n      return this.$route.name === 'manage' || this.$route.name === 'migrate';\n    },\n    showManage() {\n      return (\n        this.listCdps ||\n        (this.cdps.length >= 1 && this.cdpsWithoutProxy.length >= 1)\n      );\n    },\n    showRefresh() {\n      return this.cdps.length > 0 || this.cdpsWithoutProxy.length > 0;\n    },\n    onCreate() {\n      return this.$route.name === 'create';\n    },\n    showCreateProxy() {\n      if (this.showCdpMigrateButtons) {\n        return false;\n      }\n      return !this.hasProxy && !this.onCreate;\n    },\n    showCdpMigrateButtons() {\n      return this.hasProxy && this.cdpsWithoutProxy.length >= 1;\n    },\n    listCdps() {\n      return this.cdps.length > 1 || this.cdpsWithoutProxy.length > 1;\n    },\n    hasProxy() {\n      return this.proxyAddress !== null;\n    },\n    currentProxyAddress() {\n      return this.proxyAddress;\n    }\n  },\n  watch: {\n    ['account.address']() {\n      this.makerActive = false;\n      this.setup();\n    }\n  },\n  destroyed() {\n    this.priceService = {};\n    this.cdpService = {};\n    this.proxyService = {};\n    this.availableCdps = {};\n    this.activeCdp = {};\n    this.makerCdp = {};\n    this.sysVars = {};\n    this.sysServices = {};\n  },\n  async mounted() {\n    await this.setup();\n  },\n  methods: {\n    modalHidden() {\n      this.openCloseModal = false;\n      this.openMoveModal = false;\n    },\n    gotoHome() {\n      this.$router.push({\n        name: 'Maker'\n      });\n    },\n    gotoCreate() {\n      if (this.$route.path.includes('maker-dai')) {\n        this.activeValues = this.systemValues;\n        this.$router.push({\n          name: 'create'\n        });\n      }\n    },\n    goToManage() {\n      if (this.$route.path.includes('maker-dai')) {\n        if (this.cdps.length === 1) {\n          this.$router.push({\n            name: 'manage',\n            params: {\n              cdpId: this.cdps[0]\n            }\n          });\n        } else if (this.cdpsWithoutProxy.length === 1) {\n          this.$router.push({\n            name: 'migrate',\n            params: {\n              cdpId: this.cdpsWithoutProxy[0]\n            }\n          });\n        } else if (this.showManage) {\n          // The listing screen may not work and can be removed\n          this.$router.push({\n            name: 'select'\n          });\n        } else {\n          this.gotoCreate();\n        }\n      }\n    },\n    openManage(cdpId) {\n      if (this.$route.path.includes('maker-dai')) {\n        this.setupCdpManage(cdpId);\n        this.$router.push({\n          name: 'manage',\n          params: {\n            cdpId: cdpId\n          }\n        });\n      }\n    },\n    openMigrate(cdpId) {\n      if (this.$route.path.includes('maker-dai')) {\n        this.setupCdpManage(cdpId);\n        this.$router.push({\n          name: 'migrate',\n          params: {\n            cdpId: cdpId\n          }\n        });\n      }\n    },\n    showDeposit() {\n      this.$refs.deposit.$refs.modal.show();\n    },\n    showWithdraw() {\n      this.$refs.withdraw.$refs.modal.show();\n    },\n    showPayback() {\n      this.$refs.payback.$refs.modal.show();\n    },\n    showGenerate() {\n      this.$refs.generate.$refs.modal.show();\n    },\n    showClose() {\n      this.$refs.closeCdp.$refs.modal.$on('hidden', () => {\n        this.$emit('modalHidden');\n      });\n      this.$refs.closeCdp.$refs.modal.show();\n    },\n    showMove() {\n      this.$refs.moveCdp.$refs.modal.$on('hidden', () => {\n        this.$emit('modalHidden');\n      });\n      this.destAddressHasProxy = false;\n      this.$refs.moveCdp.$refs.modal.show();\n    },\n    async setup() {\n      this.activeCdps = {};\n      this.currentCdp = {};\n      const web3 = this.web3;\n      const _self = this;\n      this.gotoHome();\n      const MewMakerPlugin = MewPlugin(\n        web3,\n        _self.account.address,\n        async () => {\n          if (_self.$route.path.includes('maker-dai')) {\n            await _self.doUpdate();\n          }\n        }\n      );\n      this.maker = await Maker.create('inject', {\n        provider: { inject: web3.currentProvider },\n        plugins: [MewMakerPlugin],\n        accounts: {\n          myLedger1: { type: 'mew' }\n        }\n      });\n\n      await this.maker.authenticate();\n      this._priceService = this.maker.service('price');\n      this._cdpService = await this.maker.service('cdp');\n      this._proxyService = await this.maker.service('proxy');\n      this._tokenService = await this.maker.service('token');\n\n      this.pethMin = toBigNumber(0.005);\n\n      this.ethPrice = toBigNumber(\n        (await this._priceService.getEthPrice()).toNumber()\n      );\n\n      this.pethPrice = toBigNumber(\n        (await this._priceService.getPethPrice()).toNumber()\n      );\n\n      this._targetPrice = toBigNumber(\n        (await this._priceService.getPethPrice()).toNumber()\n      );\n\n      this.liquidationRatio = toBigNumber(\n        await this._cdpService.getLiquidationRatio()\n      );\n      this.liquidationPenalty = toBigNumber(\n        await this._cdpService.getLiquidationPenalty()\n      );\n      this.stabilityFee = toBigNumber(\n        await this._cdpService.getAnnualGovernanceFee()\n      );\n\n      this.wethToPethRatio = toBigNumber(\n        await this._priceService.getWethToPethRatio()\n      );\n      this.proxyAddress = await this._proxyService.currentProxy();\n\n      this.daiToken = this._tokenService.getToken(DAI);\n      this.daiBalance = (await this.daiToken.balance()).toBigNumber();\n      this.mkrToken = this._tokenService.getToken(MKR);\n      this.mkrBalance = (await this.mkrToken.balance()).toBigNumber();\n\n      const minEth = toBigNumber(this.pethMin).times(this.wethToPethRatio);\n      this.systemValues = {\n        stabilityFee: this.stabilityFee,\n        minEth: minEth,\n        liquidationRatio: this.liquidationRatio,\n        wethToPethRatio: this.wethToPethRatio,\n        liquidationPenalty: this.liquidationPenalty,\n        targetPrice: this._targetPrice,\n        pethPrice: this.pethPrice\n      };\n\n      await this.checkAllowances();\n\n      const { withProxy, withoutProxy } = await this.locateCdps();\n      this.cdps = withProxy;\n      this.cdpsWithoutProxy = withoutProxy;\n\n      if (this.cdps.length > 0 || this.cdpsWithoutProxy.length > 0) {\n        await this.loadCdpDetails();\n      }\n\n      this.currentProxy = this.getProxy();\n      if (this.cdps.length > 0 || this.cdpsWithoutProxy.length > 0) {\n        this.cdpDetailsLoaded = true;\n        this.makerActive = true;\n        if (\n          this.$route.name !== 'create' &&\n          this.$route.path.includes('maker-dai')\n        ) {\n          this.goToManage();\n        }\n      } else {\n        this.gotoCreate();\n      }\n    },\n\n    async buildEmpty() {\n      return await this.buildCdpObject(null);\n    },\n    addCdp() {\n      this.creatingCdp = true;\n    },\n    removeCdp(vals) {\n      try {\n        delete this.availableCdps[vals.id];\n        Toast.responseHandler('CDP Closed', Toast.INFO);\n      } catch (e) {\n        // eslint-disable-next-line\n        console.error(e);\n      }\n    },\n    async migrateCdpExternal(cdpId) {\n      this.afterUpdate.push(this.goToManage);\n      await this.migrateCdp(cdpId);\n    },\n    async refreshExternal() {\n      await this.doUpdate();\n    },\n    async refresh() {\n      await this.doUpdate();\n    },\n    async doUpdate() {\n      this.proxyAddress = await this.getProxy();\n      let afterClose = false;\n      const afterOpen = this.$route.name === 'create';\n      await this.updateActiveCdp();\n      for (const idProp in this.activeCdps) {\n        if (this.activeCdps[idProp].needsUpdate) {\n          if (this.activeCdps[idProp].closing) {\n            afterClose = true;\n            delete this.activeCdps[idProp];\n            this.cdps = this.cdps.filter(item => item !== idProp);\n            this.cdpsWithoutProxy = this.cdpsWithoutProxy.filter(\n              item => item !== idProp\n            );\n          } else if (this.activeCdps[idProp].opening) {\n            await this.activeCdps[idProp].updateValues();\n          } else {\n            this.activeCdps[idProp] = await this.activeCdps[idProp].update();\n          }\n        }\n        if (idProp === this.currentCdpId) {\n          await this.currentCdp.update();\n          await this.setupCdpManage(this.currentCdpId);\n        }\n      }\n\n      this.daiBalance = (await this.daiToken.balance()).toBigNumber();\n      this.mkrBalance = (await this.mkrToken.balance()).toBigNumber();\n      await this.checkAllowances();\n\n      if (!Object.keys(this.activeCdps).includes(this.currentCdpId)) {\n        await this.loadCdpDetails();\n        await this.setupCdpManage(this.currentCdpId);\n      } else {\n        await this.setupCdpManage(this.currentCdpId);\n      }\n\n      const runAfterUpdate = () => {\n        if (this.afterUpdate.length > 0) {\n          const fn = this.afterUpdate.pop();\n          fn();\n          runAfterUpdate();\n        }\n      };\n      runAfterUpdate();\n      if (afterClose || afterOpen || this.creatingCdp) {\n        if (this.cdps.length > 0 || this.cdpsWithoutProxy.length > 0) {\n          this.goToManage();\n        } else {\n          this.gotoCreate();\n        }\n      }\n      if (this.creatingCdp) {\n        this.creatingCdp = false;\n        await this.updateActiveCdp();\n        Toast.responseHandler('CDP Created', Toast.INFO);\n      } else {\n        this.valuesUpdated++;\n        Toast.responseHandler('CDP Updated', Toast.INFO);\n      }\n    },\n\n    async checkAllowances() {\n      if (this.proxyAddress) {\n        this._proxyAllowanceDai = (await this.daiToken.allowance(\n          this.account.address,\n          this.proxyAddress\n        )).toBigNumber();\n\n        this._proxyAllowanceMkr = (await this.mkrToken.allowance(\n          this.account.address,\n          this.proxyAddress\n        )).toBigNumber();\n      }\n    },\n    async setupCdpManage(cdpId) {\n      if (!this.allCdpIds.includes(cdpId) && this.allCdpIds.length > 0) {\n        cdpId = this.allCdpIds[0];\n      }\n      if (this.allCdpIds.length === 0) {\n        this.activeValues = this.systemValues;\n      } else {\n        this.currentCdpId = cdpId;\n        this.activeValues = await this.getValuesForManage(cdpId);\n      }\n    },\n    async getValuesForManage(cdpId) {\n      const currentCdp = this.activeCdps[cdpId];\n      this.currentCdp = currentCdp;\n      const _proxyAllowanceDai = this._proxyAllowanceDai;\n      const _proxyAllowanceMkr = this._proxyAllowanceMkr;\n      const toPeth = this.toPeth;\n      const systemValues = this.systemValues;\n      return {\n        ...systemValues,\n        cdpId: cdpId,\n        maxPethDraw: currentCdp.maxPethDraw,\n        maxEthDraw: currentCdp.maxEthDraw,\n        maxUsdDraw: currentCdp.maxUsdDraw,\n        ethCollateral: currentCdp.ethCollateral,\n        pethCollateral: currentCdp.pethCollateral,\n        usdCollateral: currentCdp.usdCollateral,\n        debtValue: currentCdp.debtValue,\n        maxDai: currentCdp.maxDai,\n        collateralRatio: currentCdp.collatRatio,\n        liquidationPrice: currentCdp.liquidationPrice,\n        minEth: currentCdp.minEth,\n        isSafe: false,\n        governanceFeeOwed: currentCdp.governanceFeeOwed,\n        ethCollateralNum: currentCdp.ethCollateralNum,\n        toPeth: toPeth,\n        proxyAllowanceDai: _proxyAllowanceDai,\n        proxyAllowanceMkr: _proxyAllowanceMkr,\n        zeroDebt: currentCdp.zeroDebt\n      };\n    },\n    async locateCdps() {\n      this.cdpsWithoutProxy = [];\n      this.cdpsWithoutProxy = await this.locateCdpsWithoutProxy();\n      this.cdps = [];\n      this.cdps = await this.locateCdpsProxy();\n\n      this.allCdpIds = [...this.cdpsWithoutProxy, ...this.cdps];\n\n      return { withProxy: this.cdps, withoutProxy: this.cdpsWithoutProxy };\n    },\n\n    async locateCdpsWithoutProxy() {\n      const directCdps = await this._cdpService.getCdpIds(this.account.address);\n      const directCdpsCheckSum = await this._cdpService.getCdpIds(\n        toChecksumAddress(this.account.address)\n      );\n      return directCdps.concat(directCdpsCheckSum);\n    },\n\n    async locateCdpsProxy() {\n      this.proxyAddress = await this.getProxy();\n      return await this._cdpService.getCdpIds(this.proxyAddress);\n    },\n    async updateActiveCdp() {\n      const currentCdpIds = Object.keys(this.activeCdps);\n      await this.locateCdps();\n\n      const newCdps = this.cdps.filter(\n        item => !Object.keys(this.activeCdps).includes(item.toString())\n      );\n\n      const newCdpsWithoutProxy = this.cdpsWithoutProxy.filter(\n        item => !Object.keys(this.activeCdps).includes(item.toString())\n      );\n\n      const removedCdps = currentCdpIds.filter(\n        item =>\n          !(\n            this.cdps.includes(item.toString()) ||\n            this.cdpsWithoutProxy.includes(item.toString())\n          )\n      );\n\n      if (removedCdps.length > 0) {\n        removedCdps.forEach(item => delete this.activeCdps[item]);\n      }\n\n      if (newCdps.length > 0) {\n        for (let i = 0; i < newCdps.length; i++) {\n          this.activeCdps[newCdps[i]] = await this.buildCdpObject(newCdps[i]);\n        }\n      }\n\n      if (newCdpsWithoutProxy.length > 0) {\n        for (let i = 0; i < newCdpsWithoutProxy.length; i++) {\n          this.activeCdps[newCdpsWithoutProxy[i]] = await this.buildCdpObject(\n            newCdpsWithoutProxy[i],\n            { noProxy: true }\n          );\n        }\n      }\n\n      if (this.cdps.length === 0 && this.cdpsWithoutProxy.length === 0) {\n        this.gotoCreate();\n      }\n    },\n    async loadCdpDetails() {\n      for (let i = 0; i < this.cdps.length; i++) {\n        this.activeCdps[this.cdps[i]] = await this.buildCdpObject(this.cdps[i]);\n      }\n      for (let i = 0; i < this.cdpsWithoutProxy.length; i++) {\n        this.activeCdps[this.cdpsWithoutProxy[i]] = await this.buildCdpObject(\n          this.cdpsWithoutProxy[i],\n          {\n            noProxy: true\n          }\n        );\n      }\n    },\n    async buildCdpObject(cdpId, options = {}) {\n      const sysVars = {\n        ...options,\n        _proxyAddress: this.proxyAddress,\n        liquidationPenalty: this.liquidationPenalty,\n        stabilityFee: this.stabilityFee,\n        ethPrice: this.ethPrice,\n        _pethPrice: this.pethPrice,\n        wethToPethRatio: this.wethToPethRatio,\n        _targetPrice: this._targetPrice,\n        liquidationRatio: this.liquidationRatio,\n        proxyAllowanceDai: this.proxyAllowanceDai,\n        proxyAllowanceMkr: this.proxyAllowanceMkr,\n        _daiToken: this._daiToken,\n        daiBalance: this.daiBalance,\n        _mkrToken: this._mkrToken,\n        mkrBalance: this.mkrBalance,\n        minEth: this.minEth,\n        pethMin: this.pethMin\n      };\n\n      if (this.cdpsWithoutProxy.includes(cdpId)) {\n        this.cdp = await this.getMakerCdp(cdpId, false);\n      } else if (this.cdps.includes(cdpId)) {\n        this.cdp = await this.getMakerCdp(cdpId, this.proxyAddress);\n      } else {\n        this.cdp = await this.getMakerCdp(cdpId, false);\n      }\n\n      const services = {\n        _proxyService: this._proxyService,\n        priceService: this.priceService,\n        _cdpService: this._cdpService,\n        doUpdate: this.doUpdate,\n        getProxy: this.getProxy,\n        hasProxy: this.hasProxy,\n        getCdp: this.getMakerCdp,\n        toPeth: this.toPeth,\n        toUSD: this.toUSD,\n        _proxyAddress: this.proxyAddress,\n        liquidationPenalty: this.liquidationPenalty,\n        stabilityFee: this.stabilityFee,\n        ethPrice: this.ethPrice,\n        _pethPrice: this.pethPrice,\n        wethToPethRatio: this.wethToPethRatio,\n        _targetPrice: this._targetPrice,\n        liquidationRatio: this.liquidationRatio,\n        proxyAllowanceDai: this.proxyAllowanceDai,\n        proxyAllowanceMkr: this.proxyAllowanceMkr,\n        _daiToken: this._daiToken,\n        daiBalance: this.daiBalance,\n        _mkrToken: this._mkrToken,\n        mkrBalance: this.mkrBalance,\n        minEth: this.minEth,\n        pethMin: this.pethMin\n      };\n\n      const makerCDP = new MakerCDP(cdpId, this.web3, services, sysVars);\n      if (cdpId) {\n        return await makerCDP.init(cdpId);\n      }\n      return makerCDP;\n    },\n\n    async getProxy() {\n      this.proxyAddress = await this._proxyService.currentProxy();\n      if (!this.proxyAddress) {\n        this.proxyAddress = await this._proxyService.getProxyAddress(\n          this.account.address\n        );\n        if (this.proxyAddress) this.noProxy = false;\n      }\n      return this.proxyAddress;\n    },\n\n    lockEth(val) {\n      this.currentCdp.lockEth(val);\n    },\n    wipeDai(val) {\n      this.currentCdp.wipeDai(val);\n    },\n    freeEth(val) {\n      if (val[1] === null) {\n        this.currentCdp.freeEth(val[0]);\n      } else {\n        this.currentCdp.freeEth(val[0], val[1]);\n      }\n    },\n    drawDai(val) {\n      if (val[1] === null) {\n        this.currentCdp.drawDai(val[0]);\n      } else {\n        this.currentCdp.drawDai(val[0], val[1]);\n      }\n    },\n    closeCdp() {\n      this.currentCdp.closeCdp();\n    },\n    checkIfDestAddressHasProxy(val) {\n      this.currentCdp\n        .checkIfDestAddressHasProxy(val)\n        .then(result => {\n          this.destAddressProxy = result;\n          this.destAddressHasProxy = result !== null;\n        })\n        .catch(err => {\n          throw err;\n        });\n    },\n    moveCdp(val) {\n      this.currentCdp.moveCdp(val);\n    },\n\n    calcCollatRatioDaiChg(daiQty) {\n      return toBigNumber(\n        this.currentCdp.calcCollatRatio(this.currentCdp.ethCollateral, daiQty)\n      );\n    },\n\n    calcCollatRatioEthChg(ethQty) {\n      return toBigNumber(\n        this.currentCdp.calcCollatRatio(ethQty, this.currentCdp.debtValue)\n      );\n    },\n\n    calcLiquidationPriceDaiChg(daiQty) {\n      return toBigNumber(\n        this.currentCdp.calcLiquidationPrice(\n          this.currentCdp.ethCollateral,\n          daiQty\n        )\n      );\n    },\n\n    calcLiquidationPriceEthChg(ethQty) {\n      return toBigNumber(\n        this.currentCdp.calcLiquidationPrice(ethQty, this.currentCdp.debtValue)\n      );\n    },\n    async approveDai() {\n      await this._tokenService\n        .getToken(DAI)\n        .approveUnlimited(this.proxyAddress);\n    },\n    async approveMkr() {\n      this._tokenService.getToken(MKR).approveUnlimited(this.proxyAddress);\n    },\n    hasCdp(cdpId) {\n      return Object.keys(this.activeCdps).includes(\n        toBigNumber(cdpId).toString()\n      );\n    },\n\n    getCdp(cdpId) {\n      return this.activeCdps[cdpId];\n    },\n\n    async getMakerCdp(cdpId) {\n      if (cdpId === null) return;\n      if (this.cdpsWithoutProxy.includes(cdpId)) {\n        return await this.maker.getCdp(cdpId, false);\n      } else if (this.cdps.includes(cdpId) && this.proxyAddress) {\n        return await this.maker.getCdp(cdpId, this.proxyAddress);\n      } else if (this.proxyAddress) {\n        return await this.maker.getCdp(cdpId, this.proxyAddress);\n      }\n      return await this.maker.getCdp(cdpId, false);\n    },\n\n    async buildProxy() {\n      this.proxyAddress = await this.getProxy();\n      if (!this.proxyAddress) {\n        await this._proxyService.build();\n        this.proxyAddress = await this._proxyService.currentProxy();\n        return this.proxyAddress;\n      }\n      this.proxyAddress = await this._proxyService.currentProxy();\n      return this.proxyAddress;\n    },\n\n    async migrateCdp(cdpId) {\n      const currentProxy = await this.getProxy();\n      if (currentProxy) {\n        await this._cdpService.give(cdpId, currentProxy);\n      }\n    },\n\n    // Calculations\n    minEth() {\n      if (this.wethToPethRatio) {\n        return toBigNumber(this.pethMin).times(this.wethToPethRatio);\n      }\n      return '--';\n    },\n    toUSD(eth) {\n      if (eth === undefined || eth === null) return toBigNumber(0);\n      return this.ethPrice.times(toBigNumber(eth));\n    },\n\n    toPeth(eth) {\n      if (!toBigNumber(eth).eq(0)) {\n        return toBigNumber(eth).div(this.wethToPethRatio);\n      }\n      return toBigNumber(0);\n    }\n  }\n};\n",{"version":3,"sources":["MakerDai.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAyLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"MakerDai.vue","sourceRoot":"src/dapps/MakerDai","sourcesContent":["<template>\n  <div class=\"container-maker\">\n    <deposit-modal\n      ref=\"deposit\"\n      :values=\"activeValues\"\n      :calc-collat-ratio-dai-chg=\"calcCollatRatioDaiChg\"\n      :calc-collat-ratio-eth-chg=\"calcCollatRatioEthChg\"\n      :calc-liquidation-price-eth-chg=\"calcLiquidationPriceEthChg\"\n      :calc-liquidation-price-dai-chg=\"calcLiquidationPriceDaiChg\"\n      :tokens-with-balance=\"tokensWithBalance\"\n      @lockEth=\"lockEth\"\n    ></deposit-modal>\n    <generate-modal\n      ref=\"generate\"\n      :values=\"activeValues\"\n      :calc-collat-ratio-dai-chg=\"calcCollatRatioDaiChg\"\n      :calc-collat-ratio-eth-chg=\"calcCollatRatioEthChg\"\n      :calc-liquidation-price-eth-chg=\"calcLiquidationPriceEthChg\"\n      :calc-liquidation-price-dai-chg=\"calcLiquidationPriceDaiChg\"\n      :tokens-with-balance=\"tokensWithBalance\"\n      @drawDai=\"drawDai\"\n    ></generate-modal>\n    <withdraw-modal\n      ref=\"withdraw\"\n      :values=\"activeValues\"\n      :calc-collat-ratio-dai-chg=\"calcCollatRatioDaiChg\"\n      :calc-collat-ratio-eth-chg=\"calcCollatRatioEthChg\"\n      :calc-liquidation-price-eth-chg=\"calcLiquidationPriceEthChg\"\n      :calc-liquidation-price-dai-chg=\"calcLiquidationPriceDaiChg\"\n      :tokens-with-balance=\"tokensWithBalance\"\n      @approveDai=\"approveDai\"\n      @approveMkr=\"approveMkr\"\n      @freeEth=\"freeEth\"\n    ></withdraw-modal>\n    <payback-modal\n      ref=\"payback\"\n      :values=\"activeValues\"\n      :calc-collat-ratio-dai-chg=\"calcCollatRatioDaiChg\"\n      :calc-collat-ratio-eth-chg=\"calcCollatRatioEthChg\"\n      :calc-liquidation-price-eth-chg=\"calcLiquidationPriceEthChg\"\n      :calc-liquidation-price-dai-chg=\"calcLiquidationPriceDaiChg\"\n      :tokens-with-balance=\"tokensWithBalance\"\n      @approveDai=\"approveDai\"\n      @approveMkr=\"approveMkr\"\n      @wipeDai=\"wipeDai\"\n    ></payback-modal>\n    <close-cdp-modal\n      ref=\"closeCdp\"\n      :values=\"activeValues\"\n      :calc-collat-ratio-dai-chg=\"calcCollatRatioDaiChg\"\n      :calc-collat-ratio-eth-chg=\"calcCollatRatioEthChg\"\n      :calc-liquidation-price-eth-chg=\"calcLiquidationPriceEthChg\"\n      :calc-liquidation-price-dai-chg=\"calcLiquidationPriceDaiChg\"\n      :tokens-with-balance=\"tokensWithBalance\"\n      @approveDai=\"approveDai\"\n      @approveMkr=\"approveMkr\"\n      @closeCdp=\"closeCdp\"\n    >\n    </close-cdp-modal>\n    <move-cdp-modal\n      ref=\"moveCdp\"\n      :values=\"activeValues\"\n      :calc-collat-ratio-dai-chg=\"calcCollatRatioDaiChg\"\n      :calc-collat-ratio-eth-chg=\"calcCollatRatioEthChg\"\n      :calc-liquidation-price-eth-chg=\"calcLiquidationPriceEthChg\"\n      :calc-liquidation-price-dai-chg=\"calcLiquidationPriceDaiChg\"\n      :dest-address-has-proxy=\"destAddressHasProxy\"\n      :dest-address-proxy=\"destAddressProxy\"\n      :tokens-with-balance=\"tokensWithBalance\"\n      @moveCdp=\"moveCdp\"\n      @checkForProxy=\"checkIfDestAddressHasProxy\"\n    >\n    </move-cdp-modal>\n    <back-button :path=\"'/interface/dapps/'\">\n      <div class=\"back-bar-container\">\n        <div v-if=\"showMoveOrClose\" class=\"header-buttons-container\">\n          <div class=\"inner-container\">\n            <button class=\"move-btn\" @click=\"showMove\">\n              <h4>{{ $t('dappsMaker.moveTitle') }}</h4>\n            </button>\n            <div v-if=\"!((!hasProxy && !onCreate) || showCdpMigrateButtons)\">\n              <button class=\"close-btn\" @click=\"showClose\">\n                <h4>{{ $t('dappsMaker.closeTitle') }}</h4>\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    </back-button>\n    <div v-if=\"makerActive\" class=\"buttons-container\">\n      <div v-if=\"showCreateProxy\">\n        <div class=\"dapps-button\" @click=\"buildProxy\">\n          <h4>{{ $t('dappsMaker.createProxy') }}</h4>\n        </div>\n      </div>\n      <div v-if=\"showCreateProxy\" class=\"proxy-container\">\n        {{ $t('dappsMaker.proxyInstructions') }}\n      </div>\n      <div v-if=\"showCdpMigrateButtons\">\n        <div v-for=\"(value, idx) in cdpsWithoutProxy\" :key=\"idx + value\">\n          <div class=\"dapps-button\">\n            <div @click=\"migrateCdpExternal(value)\">\n              <h4>\n                {{ $t('dappsMaker.migrateCdp', { value: value }) }}\n              </h4>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div v-if=\"showCdpMigrateButtons\" class=\"proxy-container\">\n        {{ $t('dappsMaker.migrateInstructions') }}\n      </div>\n    </div>\n    <div v-show=\"makerActive\" class=\"buttons-container\">\n      <div v-if=\"showCreateProxy && cdpsWithoutProxy.length > 1\">\n        <div v-for=\"(value, idx) in cdpsWithoutProxy\" :key=\"idx + value\">\n          <div\n            :class=\"[\n              'dapps-button',\n              activeValues.cdpId === value ? 'active' : ''\n            ]\"\n          >\n            <div @click=\"openMigrate(value)\">\n              <h4>CDP #{{ value }}</h4>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n    <div v-show=\"makerActive && listCdps\" class=\"buttons-container\">\n      <div v-for=\"(value, idx) in cdps\" :key=\"idx + value\">\n        <div\n          :class=\"[\n            'dapps-button',\n            activeValues.cdpId === value ? 'active' : ''\n          ]\"\n        >\n          <div @click=\"openManage(value)\">\n            <h4>CDP #{{ value }}</h4>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <router-view\n      :build-empty=\"buildEmpty\"\n      :maker-active=\"makerActive\"\n      :eth-price=\"ethPrice\"\n      :peth-price=\"pethPrice\"\n      :peth-min=\"pethMin\"\n      :weth-to-peth-ratio=\"wethToPethRatio\"\n      :liquidation-penalty=\"liquidationPenalty\"\n      :stability-fee=\"stabilityFee\"\n      :liquidation-ratio=\"liquidationRatio\"\n      :price-service=\"priceService\"\n      :cdp-service=\"cdpService\"\n      :proxy-service=\"proxyService\"\n      :cdps=\"cdps\"\n      :cdp-details-loaded=\"cdpDetailsLoaded\"\n      :tokens-with-balance=\"tokensWithBalance\"\n      :migration-in-progress=\"migrationInProgress\"\n      :open-close-modal=\"openCloseModal\"\n      :open-move-modal=\"openMoveModal\"\n      :values-updated=\"valuesUpdated\"\n      :values=\"activeValues\"\n      :get-cdp=\"getCdp\"\n      :has-cdp=\"hasCdp\"\n      :loading-message1=\"$t('dappsMaker.initialLoadingOne')\"\n      :loading-message2=\"$t('dappsMaker.initialLoadingTwo')\"\n      @activeCdpId=\"setupCdpManage\"\n      @cdpOpened=\"addCdp\"\n      @cdpClosed=\"removeCdp\"\n      @modalHidden=\"modalHidden\"\n      @managerUpdate=\"doUpdate\"\n      @showWithdraw=\"showWithdraw\"\n      @showPayback=\"showPayback\"\n      @showGenerate=\"showGenerate\"\n      @showDeposit=\"showDeposit\"\n      @migrateCdp=\"migrateCdpExternal\"\n    >\n    </router-view>\n  </div>\n</template>\n\n<script>\nimport { mapState } from 'vuex';\nimport BackButton from '@/layouts/InterfaceLayout/components/BackButton';\nimport InterfaceContainerTitle from '@/layouts/InterfaceLayout/components/InterfaceContainerTitle';\nimport InterfaceBottomText from '@/components/InterfaceBottomText';\nimport Blockie from '@/components/Blockie';\nimport CloseCdpModal from './components/CloseCdpModal';\nimport MoveCdpModal from './components/MoveCdpModal';\nimport GenerateModal from './components/GenerateModal';\nimport DepositModal from './components/DepositModal';\nimport WithdrawModal from './components/WithdrawModal';\nimport PaybackModal from './components/PaybackModal';\nimport BigNumber from 'bignumber.js';\nimport Maker from '@makerdao/dai';\nimport { Toast } from '@/helpers';\nimport MakerCDP from './MakerCDP';\nimport { toChecksumAddress } from '@/helpers/addressUtils';\n\nimport MewPlugin from 'mew-maker-plugin';\nconst { MKR, DAI } = Maker;\n\nconst toBigNumber = num => {\n  return new BigNumber(num);\n};\n\nconst bnOver = (one, two, three) => {\n  return toBigNumber(one)\n    .times(toBigNumber(two))\n    .div(toBigNumber(three));\n};\n\nexport default {\n  components: {\n    'interface-container-title': InterfaceContainerTitle,\n    'interface-bottom-text': InterfaceBottomText,\n    'generate-modal': GenerateModal,\n    'deposit-modal': DepositModal,\n    'withdraw-modal': WithdrawModal,\n    'payback-modal': PaybackModal,\n    blockie: Blockie,\n    'back-button': BackButton,\n    'close-cdp-modal': CloseCdpModal,\n    'move-cdp-modal': MoveCdpModal\n  },\n  props: {\n    tokensWithBalance: {\n      type: Array,\n      default: function() {\n        return [];\n      }\n    },\n    getBalance: {\n      type: Function,\n      default: function() {}\n    },\n    highestGas: {\n      type: String,\n      default: '0'\n    }\n  },\n  data() {\n    return {\n      destAddressProxy: '',\n      destAddressHasProxy: false,\n      afterUpdate: [],\n      allCdpIds: [],\n      activeCdp: {},\n      activeValues: {\n        maxPethDraw: toBigNumber(0),\n        maxEthDraw: toBigNumber(0),\n        maxUsdDraw: toBigNumber(0),\n        ethCollateral: toBigNumber(0),\n        pethCollateral: toBigNumber(0),\n        usdCollateral: toBigNumber(0),\n        debtValue: toBigNumber(0),\n        maxDai: toBigNumber(0),\n        collateralRatio: toBigNumber(0),\n        minEth: toBigNumber(0),\n        cdpId: '--'\n      },\n      availableCdps: {},\n      cdps: [],\n      cdpsWithoutProxy: [],\n      cdpService: {},\n      cdpDetailsLoaded: false,\n      currentProxy: null,\n      currentCdpId: '',\n      creatingCdp: false,\n      daiPrice: 0,\n      daiQty: 0,\n      ethPrice: toBigNumber(0),\n      ethQty: 0,\n      liquidationRatio: toBigNumber(0),\n      liquidationPenalty: toBigNumber(0),\n      makerActive: false,\n      makerCdp: {},\n      makerManager: {},\n      migrationInProgress: {},\n      openCloseModal: false,\n      openMoveModal: false,\n      proxyService: {},\n      proxyAddress: null,\n      pethPrice: toBigNumber(0),\n      pethMin: toBigNumber(0),\n      priceService: {},\n      priceFloor: 0,\n      stabilityFee: toBigNumber(0),\n      sysVars: {},\n      sysServices: {},\n      targetPrice: 0,\n      valuesUpdated: 0,\n      wethToPethRatio: toBigNumber(0)\n    };\n  },\n  computed: {\n    ...mapState(['account', 'gasPrice', 'web3', 'network', 'ens']),\n    maxDaiDraw() {\n      if (this.ethQty <= 0) return 0;\n      return bnOver(this.ethPrice, this.ethQty, this.liquidationRatio);\n    },\n    minEthDeposit() {\n      if (this.daiQty <= 0) return 0;\n      return bnOver(this.liquidationRatio, this.daiQty, this.ethPrice);\n    },\n    showMoveOrClose() {\n      return this.$route.name === 'manage' || this.$route.name === 'migrate';\n    },\n    showManage() {\n      return (\n        this.listCdps ||\n        (this.cdps.length >= 1 && this.cdpsWithoutProxy.length >= 1)\n      );\n    },\n    showRefresh() {\n      return this.cdps.length > 0 || this.cdpsWithoutProxy.length > 0;\n    },\n    onCreate() {\n      return this.$route.name === 'create';\n    },\n    showCreateProxy() {\n      if (this.showCdpMigrateButtons) {\n        return false;\n      }\n      return !this.hasProxy && !this.onCreate;\n    },\n    showCdpMigrateButtons() {\n      return this.hasProxy && this.cdpsWithoutProxy.length >= 1;\n    },\n    listCdps() {\n      return this.cdps.length > 1 || this.cdpsWithoutProxy.length > 1;\n    },\n    hasProxy() {\n      return this.proxyAddress !== null;\n    },\n    currentProxyAddress() {\n      return this.proxyAddress;\n    }\n  },\n  watch: {\n    ['account.address']() {\n      this.makerActive = false;\n      this.setup();\n    }\n  },\n  destroyed() {\n    this.priceService = {};\n    this.cdpService = {};\n    this.proxyService = {};\n    this.availableCdps = {};\n    this.activeCdp = {};\n    this.makerCdp = {};\n    this.sysVars = {};\n    this.sysServices = {};\n  },\n  async mounted() {\n    await this.setup();\n  },\n  methods: {\n    modalHidden() {\n      this.openCloseModal = false;\n      this.openMoveModal = false;\n    },\n    gotoHome() {\n      this.$router.push({\n        name: 'Maker'\n      });\n    },\n    gotoCreate() {\n      if (this.$route.path.includes('maker-dai')) {\n        this.activeValues = this.systemValues;\n        this.$router.push({\n          name: 'create'\n        });\n      }\n    },\n    goToManage() {\n      if (this.$route.path.includes('maker-dai')) {\n        if (this.cdps.length === 1) {\n          this.$router.push({\n            name: 'manage',\n            params: {\n              cdpId: this.cdps[0]\n            }\n          });\n        } else if (this.cdpsWithoutProxy.length === 1) {\n          this.$router.push({\n            name: 'migrate',\n            params: {\n              cdpId: this.cdpsWithoutProxy[0]\n            }\n          });\n        } else if (this.showManage) {\n          // The listing screen may not work and can be removed\n          this.$router.push({\n            name: 'select'\n          });\n        } else {\n          this.gotoCreate();\n        }\n      }\n    },\n    openManage(cdpId) {\n      if (this.$route.path.includes('maker-dai')) {\n        this.setupCdpManage(cdpId);\n        this.$router.push({\n          name: 'manage',\n          params: {\n            cdpId: cdpId\n          }\n        });\n      }\n    },\n    openMigrate(cdpId) {\n      if (this.$route.path.includes('maker-dai')) {\n        this.setupCdpManage(cdpId);\n        this.$router.push({\n          name: 'migrate',\n          params: {\n            cdpId: cdpId\n          }\n        });\n      }\n    },\n    showDeposit() {\n      this.$refs.deposit.$refs.modal.show();\n    },\n    showWithdraw() {\n      this.$refs.withdraw.$refs.modal.show();\n    },\n    showPayback() {\n      this.$refs.payback.$refs.modal.show();\n    },\n    showGenerate() {\n      this.$refs.generate.$refs.modal.show();\n    },\n    showClose() {\n      this.$refs.closeCdp.$refs.modal.$on('hidden', () => {\n        this.$emit('modalHidden');\n      });\n      this.$refs.closeCdp.$refs.modal.show();\n    },\n    showMove() {\n      this.$refs.moveCdp.$refs.modal.$on('hidden', () => {\n        this.$emit('modalHidden');\n      });\n      this.destAddressHasProxy = false;\n      this.$refs.moveCdp.$refs.modal.show();\n    },\n    async setup() {\n      this.activeCdps = {};\n      this.currentCdp = {};\n      const web3 = this.web3;\n      const _self = this;\n      this.gotoHome();\n      const MewMakerPlugin = MewPlugin(\n        web3,\n        _self.account.address,\n        async () => {\n          if (_self.$route.path.includes('maker-dai')) {\n            await _self.doUpdate();\n          }\n        }\n      );\n      this.maker = await Maker.create('inject', {\n        provider: { inject: web3.currentProvider },\n        plugins: [MewMakerPlugin],\n        accounts: {\n          myLedger1: { type: 'mew' }\n        }\n      });\n\n      await this.maker.authenticate();\n      this._priceService = this.maker.service('price');\n      this._cdpService = await this.maker.service('cdp');\n      this._proxyService = await this.maker.service('proxy');\n      this._tokenService = await this.maker.service('token');\n\n      this.pethMin = toBigNumber(0.005);\n\n      this.ethPrice = toBigNumber(\n        (await this._priceService.getEthPrice()).toNumber()\n      );\n\n      this.pethPrice = toBigNumber(\n        (await this._priceService.getPethPrice()).toNumber()\n      );\n\n      this._targetPrice = toBigNumber(\n        (await this._priceService.getPethPrice()).toNumber()\n      );\n\n      this.liquidationRatio = toBigNumber(\n        await this._cdpService.getLiquidationRatio()\n      );\n      this.liquidationPenalty = toBigNumber(\n        await this._cdpService.getLiquidationPenalty()\n      );\n      this.stabilityFee = toBigNumber(\n        await this._cdpService.getAnnualGovernanceFee()\n      );\n\n      this.wethToPethRatio = toBigNumber(\n        await this._priceService.getWethToPethRatio()\n      );\n      this.proxyAddress = await this._proxyService.currentProxy();\n\n      this.daiToken = this._tokenService.getToken(DAI);\n      this.daiBalance = (await this.daiToken.balance()).toBigNumber();\n      this.mkrToken = this._tokenService.getToken(MKR);\n      this.mkrBalance = (await this.mkrToken.balance()).toBigNumber();\n\n      const minEth = toBigNumber(this.pethMin).times(this.wethToPethRatio);\n      this.systemValues = {\n        stabilityFee: this.stabilityFee,\n        minEth: minEth,\n        liquidationRatio: this.liquidationRatio,\n        wethToPethRatio: this.wethToPethRatio,\n        liquidationPenalty: this.liquidationPenalty,\n        targetPrice: this._targetPrice,\n        pethPrice: this.pethPrice\n      };\n\n      await this.checkAllowances();\n\n      const { withProxy, withoutProxy } = await this.locateCdps();\n      this.cdps = withProxy;\n      this.cdpsWithoutProxy = withoutProxy;\n\n      if (this.cdps.length > 0 || this.cdpsWithoutProxy.length > 0) {\n        await this.loadCdpDetails();\n      }\n\n      this.currentProxy = this.getProxy();\n      if (this.cdps.length > 0 || this.cdpsWithoutProxy.length > 0) {\n        this.cdpDetailsLoaded = true;\n        this.makerActive = true;\n        if (\n          this.$route.name !== 'create' &&\n          this.$route.path.includes('maker-dai')\n        ) {\n          this.goToManage();\n        }\n      } else {\n        this.gotoCreate();\n      }\n    },\n\n    async buildEmpty() {\n      return await this.buildCdpObject(null);\n    },\n    addCdp() {\n      this.creatingCdp = true;\n    },\n    removeCdp(vals) {\n      try {\n        delete this.availableCdps[vals.id];\n        Toast.responseHandler('CDP Closed', Toast.INFO);\n      } catch (e) {\n        // eslint-disable-next-line\n        console.error(e);\n      }\n    },\n    async migrateCdpExternal(cdpId) {\n      this.afterUpdate.push(this.goToManage);\n      await this.migrateCdp(cdpId);\n    },\n    async refreshExternal() {\n      await this.doUpdate();\n    },\n    async refresh() {\n      await this.doUpdate();\n    },\n    async doUpdate() {\n      this.proxyAddress = await this.getProxy();\n      let afterClose = false;\n      const afterOpen = this.$route.name === 'create';\n      await this.updateActiveCdp();\n      for (const idProp in this.activeCdps) {\n        if (this.activeCdps[idProp].needsUpdate) {\n          if (this.activeCdps[idProp].closing) {\n            afterClose = true;\n            delete this.activeCdps[idProp];\n            this.cdps = this.cdps.filter(item => item !== idProp);\n            this.cdpsWithoutProxy = this.cdpsWithoutProxy.filter(\n              item => item !== idProp\n            );\n          } else if (this.activeCdps[idProp].opening) {\n            await this.activeCdps[idProp].updateValues();\n          } else {\n            this.activeCdps[idProp] = await this.activeCdps[idProp].update();\n          }\n        }\n        if (idProp === this.currentCdpId) {\n          await this.currentCdp.update();\n          await this.setupCdpManage(this.currentCdpId);\n        }\n      }\n\n      this.daiBalance = (await this.daiToken.balance()).toBigNumber();\n      this.mkrBalance = (await this.mkrToken.balance()).toBigNumber();\n      await this.checkAllowances();\n\n      if (!Object.keys(this.activeCdps).includes(this.currentCdpId)) {\n        await this.loadCdpDetails();\n        await this.setupCdpManage(this.currentCdpId);\n      } else {\n        await this.setupCdpManage(this.currentCdpId);\n      }\n\n      const runAfterUpdate = () => {\n        if (this.afterUpdate.length > 0) {\n          const fn = this.afterUpdate.pop();\n          fn();\n          runAfterUpdate();\n        }\n      };\n      runAfterUpdate();\n      if (afterClose || afterOpen || this.creatingCdp) {\n        if (this.cdps.length > 0 || this.cdpsWithoutProxy.length > 0) {\n          this.goToManage();\n        } else {\n          this.gotoCreate();\n        }\n      }\n      if (this.creatingCdp) {\n        this.creatingCdp = false;\n        await this.updateActiveCdp();\n        Toast.responseHandler('CDP Created', Toast.INFO);\n      } else {\n        this.valuesUpdated++;\n        Toast.responseHandler('CDP Updated', Toast.INFO);\n      }\n    },\n\n    async checkAllowances() {\n      if (this.proxyAddress) {\n        this._proxyAllowanceDai = (await this.daiToken.allowance(\n          this.account.address,\n          this.proxyAddress\n        )).toBigNumber();\n\n        this._proxyAllowanceMkr = (await this.mkrToken.allowance(\n          this.account.address,\n          this.proxyAddress\n        )).toBigNumber();\n      }\n    },\n    async setupCdpManage(cdpId) {\n      if (!this.allCdpIds.includes(cdpId) && this.allCdpIds.length > 0) {\n        cdpId = this.allCdpIds[0];\n      }\n      if (this.allCdpIds.length === 0) {\n        this.activeValues = this.systemValues;\n      } else {\n        this.currentCdpId = cdpId;\n        this.activeValues = await this.getValuesForManage(cdpId);\n      }\n    },\n    async getValuesForManage(cdpId) {\n      const currentCdp = this.activeCdps[cdpId];\n      this.currentCdp = currentCdp;\n      const _proxyAllowanceDai = this._proxyAllowanceDai;\n      const _proxyAllowanceMkr = this._proxyAllowanceMkr;\n      const toPeth = this.toPeth;\n      const systemValues = this.systemValues;\n      return {\n        ...systemValues,\n        cdpId: cdpId,\n        maxPethDraw: currentCdp.maxPethDraw,\n        maxEthDraw: currentCdp.maxEthDraw,\n        maxUsdDraw: currentCdp.maxUsdDraw,\n        ethCollateral: currentCdp.ethCollateral,\n        pethCollateral: currentCdp.pethCollateral,\n        usdCollateral: currentCdp.usdCollateral,\n        debtValue: currentCdp.debtValue,\n        maxDai: currentCdp.maxDai,\n        collateralRatio: currentCdp.collatRatio,\n        liquidationPrice: currentCdp.liquidationPrice,\n        minEth: currentCdp.minEth,\n        isSafe: false,\n        governanceFeeOwed: currentCdp.governanceFeeOwed,\n        ethCollateralNum: currentCdp.ethCollateralNum,\n        toPeth: toPeth,\n        proxyAllowanceDai: _proxyAllowanceDai,\n        proxyAllowanceMkr: _proxyAllowanceMkr,\n        zeroDebt: currentCdp.zeroDebt\n      };\n    },\n    async locateCdps() {\n      this.cdpsWithoutProxy = [];\n      this.cdpsWithoutProxy = await this.locateCdpsWithoutProxy();\n      this.cdps = [];\n      this.cdps = await this.locateCdpsProxy();\n\n      this.allCdpIds = [...this.cdpsWithoutProxy, ...this.cdps];\n\n      return { withProxy: this.cdps, withoutProxy: this.cdpsWithoutProxy };\n    },\n\n    async locateCdpsWithoutProxy() {\n      const directCdps = await this._cdpService.getCdpIds(this.account.address);\n      const directCdpsCheckSum = await this._cdpService.getCdpIds(\n        toChecksumAddress(this.account.address)\n      );\n      return directCdps.concat(directCdpsCheckSum);\n    },\n\n    async locateCdpsProxy() {\n      this.proxyAddress = await this.getProxy();\n      return await this._cdpService.getCdpIds(this.proxyAddress);\n    },\n    async updateActiveCdp() {\n      const currentCdpIds = Object.keys(this.activeCdps);\n      await this.locateCdps();\n\n      const newCdps = this.cdps.filter(\n        item => !Object.keys(this.activeCdps).includes(item.toString())\n      );\n\n      const newCdpsWithoutProxy = this.cdpsWithoutProxy.filter(\n        item => !Object.keys(this.activeCdps).includes(item.toString())\n      );\n\n      const removedCdps = currentCdpIds.filter(\n        item =>\n          !(\n            this.cdps.includes(item.toString()) ||\n            this.cdpsWithoutProxy.includes(item.toString())\n          )\n      );\n\n      if (removedCdps.length > 0) {\n        removedCdps.forEach(item => delete this.activeCdps[item]);\n      }\n\n      if (newCdps.length > 0) {\n        for (let i = 0; i < newCdps.length; i++) {\n          this.activeCdps[newCdps[i]] = await this.buildCdpObject(newCdps[i]);\n        }\n      }\n\n      if (newCdpsWithoutProxy.length > 0) {\n        for (let i = 0; i < newCdpsWithoutProxy.length; i++) {\n          this.activeCdps[newCdpsWithoutProxy[i]] = await this.buildCdpObject(\n            newCdpsWithoutProxy[i],\n            { noProxy: true }\n          );\n        }\n      }\n\n      if (this.cdps.length === 0 && this.cdpsWithoutProxy.length === 0) {\n        this.gotoCreate();\n      }\n    },\n    async loadCdpDetails() {\n      for (let i = 0; i < this.cdps.length; i++) {\n        this.activeCdps[this.cdps[i]] = await this.buildCdpObject(this.cdps[i]);\n      }\n      for (let i = 0; i < this.cdpsWithoutProxy.length; i++) {\n        this.activeCdps[this.cdpsWithoutProxy[i]] = await this.buildCdpObject(\n          this.cdpsWithoutProxy[i],\n          {\n            noProxy: true\n          }\n        );\n      }\n    },\n    async buildCdpObject(cdpId, options = {}) {\n      const sysVars = {\n        ...options,\n        _proxyAddress: this.proxyAddress,\n        liquidationPenalty: this.liquidationPenalty,\n        stabilityFee: this.stabilityFee,\n        ethPrice: this.ethPrice,\n        _pethPrice: this.pethPrice,\n        wethToPethRatio: this.wethToPethRatio,\n        _targetPrice: this._targetPrice,\n        liquidationRatio: this.liquidationRatio,\n        proxyAllowanceDai: this.proxyAllowanceDai,\n        proxyAllowanceMkr: this.proxyAllowanceMkr,\n        _daiToken: this._daiToken,\n        daiBalance: this.daiBalance,\n        _mkrToken: this._mkrToken,\n        mkrBalance: this.mkrBalance,\n        minEth: this.minEth,\n        pethMin: this.pethMin\n      };\n\n      if (this.cdpsWithoutProxy.includes(cdpId)) {\n        this.cdp = await this.getMakerCdp(cdpId, false);\n      } else if (this.cdps.includes(cdpId)) {\n        this.cdp = await this.getMakerCdp(cdpId, this.proxyAddress);\n      } else {\n        this.cdp = await this.getMakerCdp(cdpId, false);\n      }\n\n      const services = {\n        _proxyService: this._proxyService,\n        priceService: this.priceService,\n        _cdpService: this._cdpService,\n        doUpdate: this.doUpdate,\n        getProxy: this.getProxy,\n        hasProxy: this.hasProxy,\n        getCdp: this.getMakerCdp,\n        toPeth: this.toPeth,\n        toUSD: this.toUSD,\n        _proxyAddress: this.proxyAddress,\n        liquidationPenalty: this.liquidationPenalty,\n        stabilityFee: this.stabilityFee,\n        ethPrice: this.ethPrice,\n        _pethPrice: this.pethPrice,\n        wethToPethRatio: this.wethToPethRatio,\n        _targetPrice: this._targetPrice,\n        liquidationRatio: this.liquidationRatio,\n        proxyAllowanceDai: this.proxyAllowanceDai,\n        proxyAllowanceMkr: this.proxyAllowanceMkr,\n        _daiToken: this._daiToken,\n        daiBalance: this.daiBalance,\n        _mkrToken: this._mkrToken,\n        mkrBalance: this.mkrBalance,\n        minEth: this.minEth,\n        pethMin: this.pethMin\n      };\n\n      const makerCDP = new MakerCDP(cdpId, this.web3, services, sysVars);\n      if (cdpId) {\n        return await makerCDP.init(cdpId);\n      }\n      return makerCDP;\n    },\n\n    async getProxy() {\n      this.proxyAddress = await this._proxyService.currentProxy();\n      if (!this.proxyAddress) {\n        this.proxyAddress = await this._proxyService.getProxyAddress(\n          this.account.address\n        );\n        if (this.proxyAddress) this.noProxy = false;\n      }\n      return this.proxyAddress;\n    },\n\n    lockEth(val) {\n      this.currentCdp.lockEth(val);\n    },\n    wipeDai(val) {\n      this.currentCdp.wipeDai(val);\n    },\n    freeEth(val) {\n      if (val[1] === null) {\n        this.currentCdp.freeEth(val[0]);\n      } else {\n        this.currentCdp.freeEth(val[0], val[1]);\n      }\n    },\n    drawDai(val) {\n      if (val[1] === null) {\n        this.currentCdp.drawDai(val[0]);\n      } else {\n        this.currentCdp.drawDai(val[0], val[1]);\n      }\n    },\n    closeCdp() {\n      this.currentCdp.closeCdp();\n    },\n    checkIfDestAddressHasProxy(val) {\n      this.currentCdp\n        .checkIfDestAddressHasProxy(val)\n        .then(result => {\n          this.destAddressProxy = result;\n          this.destAddressHasProxy = result !== null;\n        })\n        .catch(err => {\n          throw err;\n        });\n    },\n    moveCdp(val) {\n      this.currentCdp.moveCdp(val);\n    },\n\n    calcCollatRatioDaiChg(daiQty) {\n      return toBigNumber(\n        this.currentCdp.calcCollatRatio(this.currentCdp.ethCollateral, daiQty)\n      );\n    },\n\n    calcCollatRatioEthChg(ethQty) {\n      return toBigNumber(\n        this.currentCdp.calcCollatRatio(ethQty, this.currentCdp.debtValue)\n      );\n    },\n\n    calcLiquidationPriceDaiChg(daiQty) {\n      return toBigNumber(\n        this.currentCdp.calcLiquidationPrice(\n          this.currentCdp.ethCollateral,\n          daiQty\n        )\n      );\n    },\n\n    calcLiquidationPriceEthChg(ethQty) {\n      return toBigNumber(\n        this.currentCdp.calcLiquidationPrice(ethQty, this.currentCdp.debtValue)\n      );\n    },\n    async approveDai() {\n      await this._tokenService\n        .getToken(DAI)\n        .approveUnlimited(this.proxyAddress);\n    },\n    async approveMkr() {\n      this._tokenService.getToken(MKR).approveUnlimited(this.proxyAddress);\n    },\n    hasCdp(cdpId) {\n      return Object.keys(this.activeCdps).includes(\n        toBigNumber(cdpId).toString()\n      );\n    },\n\n    getCdp(cdpId) {\n      return this.activeCdps[cdpId];\n    },\n\n    async getMakerCdp(cdpId) {\n      if (cdpId === null) return;\n      if (this.cdpsWithoutProxy.includes(cdpId)) {\n        return await this.maker.getCdp(cdpId, false);\n      } else if (this.cdps.includes(cdpId) && this.proxyAddress) {\n        return await this.maker.getCdp(cdpId, this.proxyAddress);\n      } else if (this.proxyAddress) {\n        return await this.maker.getCdp(cdpId, this.proxyAddress);\n      }\n      return await this.maker.getCdp(cdpId, false);\n    },\n\n    async buildProxy() {\n      this.proxyAddress = await this.getProxy();\n      if (!this.proxyAddress) {\n        await this._proxyService.build();\n        this.proxyAddress = await this._proxyService.currentProxy();\n        return this.proxyAddress;\n      }\n      this.proxyAddress = await this._proxyService.currentProxy();\n      return this.proxyAddress;\n    },\n\n    async migrateCdp(cdpId) {\n      const currentProxy = await this.getProxy();\n      if (currentProxy) {\n        await this._cdpService.give(cdpId, currentProxy);\n      }\n    },\n\n    // Calculations\n    minEth() {\n      if (this.wethToPethRatio) {\n        return toBigNumber(this.pethMin).times(this.wethToPethRatio);\n      }\n      return '--';\n    },\n    toUSD(eth) {\n      if (eth === undefined || eth === null) return toBigNumber(0);\n      return this.ethPrice.times(toBigNumber(eth));\n    },\n\n    toPeth(eth) {\n      if (!toBigNumber(eth).eq(0)) {\n        return toBigNumber(eth).div(this.wethToPethRatio);\n      }\n      return toBigNumber(0);\n    }\n  }\n};\n</script>\n\n<style lang=\"scss\" scoped>\n@import 'MakerDai.scss';\n</style>\n"]}]}